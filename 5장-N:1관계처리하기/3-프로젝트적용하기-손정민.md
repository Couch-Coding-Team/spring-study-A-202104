# 05-08 ë°œí‘œìë£Œ

## 5.3 í”„ë¡œì íŠ¸ ì ìš©í•˜ê¸°

ì•ì„œ ë°°ìš´ Boardì™€ Member, Replyë¥¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´, ê¸°ì¡´ì˜ í”„ë¡œì íŠ¸ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ì‹¤ì œë¡œ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì½”ë“œ ì‘ì„±

ğŸ‘‰ ëª©ë¡ 

- DTO ê³„ì¸µê³¼ ì„œë¹„ìŠ¤ ê³„ì¸µ ì‘ì„±
- ê²Œì‹œë¬¼ ë“±ë¡
- ê²Œì‹œë¬¼ ëª©ë¡ ì²˜ë¦¬
- ê²Œì‹œë¬¼ ì¡°íšŒ ì²˜ë¦¬
- ê²Œì‹œë¬¼ ì‚­ì œ ì²˜ë¦¬
- ê²Œì‹œë¬¼ ìˆ˜ì • ì²˜ë¦¬

### 5.3.1 DTO ê³„ì¸µê³¼ ì„œë¹„ìŠ¤ ê³„ì¸µ ì‘ì„±

```java
// dto íŒ¨í‚¤ì§€ ìƒì„± -> BoardDTO Class ìƒì„±
package org.zerock.board.dto;

import lombok.*;
import java.time.LocalDateTime;

@Data
@ToString
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class BoardDTO {
	private Long bno;
	private String title;
	private String content;
	private String writerEmail;    // ì‘ì„±ìì˜ ì´ë©”ì¼(id)
	private String writerName;     // ì‘ì„±ìì˜ ì´ë¦„
	private LocalDateTime regDate;
	private LocalDateTime modDate;
	private int replyCount;    // í•´ë‹¹ ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ìˆ˜
}
```

ğŸ‘‰ BoardDTO í´ë˜ìŠ¤ì™€ Board ì—”í‹°í‹° í´ë˜ìŠ¤ì˜ ì°¨ì´ì 

- Memberë¥¼ ì°¸ì¡°í•˜ëŠ” ëŒ€ì‹ ì— í™”ë©´ì—ì„œ í•„ìš”í•œ ì‘ì„±ìì˜ ì´ë©”ì¼(writerEmail)ê³¼ ì‘ì„±ìì˜ ì´ë¦„(writerName)ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ìˆëŠ” ì 

### 5.3.2 ê²Œì‹œë¬¼ ë“±ë¡

```java
default Board dtoToEntity(BoardDTO dto)   {
	Member member = Member.builder().email(dto.getWriterEmail()).build();
	
	Board board = Board.builder()
					.bno(dto.getBno())
					.title(dto.getTitle())
					.content(dto.getContent())
					.writer(member)
					.build();
			return board;     // ìƒì„±ëœ ê²Œì‹œë¶ˆì˜ ë²ˆí˜¸ ë°˜í™˜
}
```

ğŸ‘‰ BoardDTOë¥¼ Board ì—”í‹°í‹° íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê¸°ëŠ¥ì„ BoardService ì¸í„°í˜ì´ìŠ¤ ë‚´ì— dtoToEntity()ì‘ì„±

```java
@Override
public Long register(BoardDTO dto) {
	log.info(dto);
	Board board = dtoToEntity(dto);
	repository.save(board);
	return board.getBno();
}
```

ğŸ‘‰ dtoToEntity()ëŠ” DTOê°€ ì—°ê´€ê´€ê³„ë¥¼ ê°€ì§„ Board ì—”í‹°í‹° ê°ì²´ì™€ Member ì—”í‹°í‹° ê°ì²´ë¥¼ êµ¬ì„±í•´ì•¼ í•˜ë¯€ë¡œ ë‚´ë¶€ì ìœ¼ë¡œ Member ì—”í‹°í‹°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì • í•„ìš”

 dtoToEntity()ëŠ” BoardServiceImplì˜ register()ì—ì„œ ì‚¬ìš©

### 5.3.3 ê²Œì‹œë¬¼ ëª©ë¡ ì²˜ë¦¬

- Object[]ì„ DTOë¡œ ë³€í™˜í•˜ê¸°

    PageResultDTOëŠ” JPQLì˜ ê²°ê³¼ë¡œ ë‚˜ì˜¤ëŠ” Object[]ì„ DTO íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê¸°ëŠ¥

    ì˜ˆì œì˜ ê²½ìš° JPQLì˜ ì‹¤í–‰ ê²°ê³¼ë¡œ ë‚˜ì˜¤ëŠ” Object[]ì„ BoardDTOë¡œ ì²˜ë¦¬í•´ì£¼ì–´ì•¼í•¨

    â‡’ Service ì¸í„°í˜ì´ìŠ¤ì— entityToDTO()ë¼ëŠ” ë©”ì„œë“œë¥¼ ì‘ì„±í•´ì„œ ì²˜ë¦¬

```java
// BoardService ì¸í„°í˜ì´ìŠ¤ì— ì¶”ê°€í•˜ëŠ” entityDTO()
default BoardDTO entityToDTO(Board board, Member member, Long replyCount){
	BoardDTO boardDTO = BoardDTO.builder()
							.bno(board.getBno())
							.title(board.getTitle())
							.content(board.getConTent())
							.regDate(board.getRegDate())
							.modDate(board.getModDate())
							.writerEmail(member.getEmail())
							.writerName(membet.getName())
							.replyCount(replyCount.inValue())
							.build();

		return boardDTO;
}
```

ğŸ‘‰ ê²Œì‹œë¬¼ì˜ ëª©ë¡ ì²˜ë¦¬ë¥¼ ì˜ë¯¸í•˜ëŠ” ê¸°ëŠ¥ getList()

```java
PageResultDTO<BoardDTO, Object[]> getList(PageRequestDTO pageRequestDTO);  // ëª©ë¡ ì²˜ë¦¬
```

```java
// í´ë˜ìŠ¤ì— êµ¬í˜„ ì¶”ê°€
@Override
public PageResultDTO<BoardDTO, Object[]> getList(PageRequestDTO pageRequestDTO) {

		log.info(pageRequestDTO);

		Function<Object[], BoardDTO> fn = (en -> entityToDTO((Board)en[0],(Member)en[1],(Long)en[2]));
		
		Page<Object[]> result = repository.getBoardWithReplyCount(
				pageRequestDTO.getPageable(Sort.by("bno").descending()));

		return new PageResultDTO<>(result, fn);
}
```

### 5.3.4 ê²Œì‹œë¬¼ ì¡°íšŒ ì²˜ë¦¬

ğŸ‘‰ BoardServiceImpl í´ë˜ìŠ¤ì— get() ë©”ì„œë“œ ì¶”ê°€

```java
public interface BoardService {
	Long register(BoardDTO dto);

	PageResultDTO<BoardDTO, Object[]> getList(PageRequestDTO pageRequestDTO);

	BoardDTO get(Long bno);
```

ğŸ‘‰ BoardRepositoryì˜ Board ì—”í‹°í‹°ì™€ Member ì—”í‹°í‹°, ëŒ“ê¸€ì˜ ìˆ˜(Long)ì„ ê°€ì ¸ì˜¤ëŠ” getBoardByBno()ë¥¼ ì´ìš©

```java
@Override
public BoardDTO get(Long bno) {
	Object result = repository.getBoardByBno(bno);
	Object[] arr = (Object[])result;

	return entityToDTO((Board)arr[0], (Member)arr[1], (Long)arr[2]);
}
```

### 5.3.5 ê²Œì‹œë¬¼ ì‚­ì œ ì²˜ë¦¬

ğŸ‘‰ ì‹¤ì œ ê°œë°œì‹œ ê²Œì‹œë¬¼ ì‚­ì œ ê¸°ëŠ¥ì€ í•œë²ˆ ë” ê³ ë¯¼ì„ í•´ë´ì•¼ í•˜ëŠ” ë¶€ë¶„ì´ë‹¤. ë”°ë¼ì„œ ê²Œì‹œë¬¼ì— ìƒíƒœ(state)ë¥¼ ì¹¼ëŸ¼ìœ¼ë¡œ ì§€ì •í•˜ê³  ì´ë¥¼ ë³€ê²½í•˜ëŠ” í˜•íƒœë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì 

```java
public interface ReplyRepository extends JpaRepository<Reply, Long>
	@Modifying
	@Query("delete from Reply r where r.board.bno =:bno ")
	void deleteByBno(Long bno);
}
```

```java
@Transactional
@Override
public void removeWithReplies(Long bno) {

	replyRepository.deleteByBno(bno);
	repository.deleteById(bno);
}
```

ğŸ‘‰ ReplyRepositoryì— íŠ¹ì • ê²Œì‹œë¬¼ ë²ˆí˜¸(bno)ë¡œ ëŒ“ê¸€ì„ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ ì¶”ê°€

ğŸ‘‰ JPQLì„ ì´ìš©í•´ update, deleteë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œ @Modifyingì„ ì¶”ê°€

### 5.3.6 ê²Œì‹œë¬¼ ìˆ˜ì • ì²˜ë¦¬

ğŸ‘‰ BoardRepositoryì˜ save()ë¥¼ ì´ìš©í•´ì„œ ì²˜ë¦¬ ('ì œëª©(title)ê³¼ ë‚´ìš©(content)'ì— í•œí•´ì„œ ìˆ˜ì • ê°€ëŠ¥)

```java
private String title;
private String content;

public void changeTitle(String title){
	this.title = title;
}
public void changeContent(String content){
	this.content = content;
}
```

ğŸ‘‰ BoardServiceì—ì„œ BoardDTOë¥¼ ì´ìš©í•´ modify()ì„ ì–¸, BoardServiceImplì—ì„œ êµ¬í˜„

```java
public interface BoardService {
	void modify(BoardDTO boardDTO);
}
```

```java
@Override
public void modify(BoardDTO boardDTO) {

	Board board = repository.getOne(boardDTO.getBon());

	if(board != null) {
			board.changeTitle(boardDTO.getTitle());
			board.changeContent(boardDTO.getContent());

			repository.save(board);
}
```

ğŸ‘‰ modify()ëŠ” findById()ë¥¼ ì´ìš©í•˜ëŠ” ëŒ€ì‹ ì— getOne()ì„ ì´ìš©í•´ì„œ ì²˜ë¦¬
