# 05-05 ë°œí‘œìë£Œ

## 04.10 ê²€ìƒ‰ ì²˜ë¦¬

ğŸ‘‰ **ì„œë²„ ì‚¬ì´ë“œ ì²˜ë¦¬**

- PageRequestDTOì— ê²€ìƒ‰ íƒ€ì…(type)ê³¼ í‚¤ì›Œë“œ(keyword)ë¥¼ ì¶”ê°€
- ì´í•˜ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ Querydslì„ ì´ìš©í•´ì„œ ê²€ìƒ‰ ì²˜ë¦¬

ğŸ‘‰ **ê²€ìƒ‰ í•­ëª©**

- 'ì œëª©(t), ë‚´ìš©(c), ì‘ì„±ì(w)'ë¡œ ê²€ìƒ‰í•˜ëŠ” ê²½ìš°
- 'ì œëª© í˜¹ì€ ë‚´ìš©(tc)'ìœ¼ë¡œ ê²€ìƒ‰í•˜ëŠ” ê²½ìš°
- 'ì œëª© í˜¹ì€ ë‚´ìš© í˜¹ì€ ì‘ì„±ì(tcw)'ë¡œ ê²€ìƒ‰í•˜ëŠ” ê²½ìš°

---

### 4.10.1 ì„œë²„ì¸¡ ê²€ìƒ‰ ì²˜ë¦¬

```java
package org.zerock.guestbook.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;

@Builder
@AllArgsConstructor
@Data
public class PageRequestDTO {
	private int page;
	private int size;
	private String type;
	private String keyword;

	public PageRequestDTO(){
		this.page = 1;
		this.size = 10;
	}

	public Pageable getPageable(Sort sort){
		return PageRequest.of(page -1, size, sort);
	}
}
```

---

### 4.10.2 ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ê²€ìƒ‰ êµ¬í˜„ê³¼ í…ŒìŠ¤íŠ¸

ë™ì ìœ¼ë¡œ ê²€ìƒ‰ ì¡°ê±´ì´ ì²˜ë¦¬ë˜ëŠ” ê²½ìš°ì˜ ì‹¤ì œ ì½”ë”©ì€ **Querydsl**ì„ í†µí•´ì„œ **BooleanBuilder**ë¥¼ ì‘ì„±

 GuestbookRepositoryëŠ” Querydslë¡œ ì‘ì„±ëœ BooleanBuilderë¥¼ **findAll()**ì²˜ë¦¬í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©

  ã„´ BooleanBuilder ì‘ì„±ì˜ ê°„í¸í™” â†’ GuestbookServiceImplë‚´ì— ë©”ì„œë“œ ì¶”ê°€

```java
import com.querydsl.core.BooleanBuilder;
import com.querydsl.core.types.dsl.BooleanExpression;

private BooleanBuilder getSearch(PageRequestDTO requestDTO){ // Querydsl ì²˜ë¦¬
	String type = requestDTO.getType();
	BooleanBuilder booleanBuilder = new BooleanBuilder();
	QGuestbook qGuestbook = QGuestbook.guestbook;
	String keyword = requestDTO.getKeyword();
	BooleanExpression expression = qGuestbook.gno.gt(0L); // gno > 0 ì¡°ê±´ë§Œ ìƒì„±
	booleanBuilder.and(expression);

	if(type == null || type.trim().length() == 0){ // ê²€ìƒ‰ ì¡°ê±´ì´ ì—†ëŠ” ê²½ìš°
			return booleanBuilder;
	}

	// ê²€ìƒ‰ ì¡°ê±´ì„ ì‘ì„±í•˜ê¸°
	BooleanBuilder conditionBuilder = new BooleanBuilder();

	if(type.contains("t")){
			conditionBuilder.or(qGuestbook.title.contains(keyword));
	}
	if(type.contains("c")){
			conditionBuilder.or(qGuestbook.content.contains(keyword));
	}
	if(type.contains("w")){
			conditionBuilder.or(qGuestbook.writer.contains(keyword));
	}

	// ëª¨ë“  ì¡°ê±´ ì¢…í•©
	booleanBuilder.and(conditionBuilder);

	return booleanBuilder;
```

```java
@Override
public PageResultDTO<GuestbookDTO, Guestbook> getList(PageRequestDTO requestDTO) {
	Pageable pageable = requestDTO.getPageable(Sort.by("gno").descending());

	BooleanBuilder booleanBuilder = getSearcg(requestDTO); // ê²€ìƒ‰ ì¡°ê±´ ì²˜ë¦¬

	Page<Guestbook, GuestbookDTO> fn = (entity -> entityToDto(entity));
	
	return new PageResultDTO<>(result, fn );
}
```

---

ì„œë¹„ìŠ¤ ì˜ì—­ì—ì„œ ê²€ìƒ‰ ì¡°ê±´ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•œ ê²ƒì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
@Test
public void testSearch(){
	PageRequestDTO pageRequestDTO = PageRequestDTo.builder()
					.page(1)
					.size(10)
					.type("tc")   // ê²€ìƒ‰ ì¡°ê±´ t, c, w, tc, tcw ..
					.keyword("í•œê¸€")  // ê²€ìƒ‰ í‚¤ì›Œë“œ
					.build();
	PageResultDTO<GuestbookDTO, Guestbook> resultDTO = service.getList(pageRequestDTO);

	System.out.println("PREV: "+resultDTO.isPrev());
	System.out.println("NEXT: "+resultDTO.isNext());
	System.out.println("TOTAL: "+resultDTO.getTotalaPage());

	System.out.println("----------------------------------------");
	for (GuestbookDTO guestbookDTO : resultDTO.getDtoList()) {
			System.out.println(guestbookDTO);
	}

	System.out.println("=========================================");
	resultDTO.getPageList().forEach(i -> System.out.println(i));
}
```

> ê²°ê³¼

Hibernate:
        select
                guestbook0_.gno as gno1_0_,
                guestbook0_.moddate as moddate2_0_,
                guestbook0_.regdate as regdate3_0_,
                guestbook0_.content as content4_0_,
                guestbook0_.title as title5_0_,
                guestbook0_.writer as writer6_0_
        from
                guestbook guestbook0_
        where
                guestbook0_.gno>?
                and (
                        guestbook0_.title like ? escape '!'
                        or guestbook0_.content like ? escape '!'
                )
        order by
                guestbook0_.gno desc limit ?

---

### 4.10.3 ëª©ë¡ í˜ì´ì§€ ê²€ìƒ‰ ì²˜ë¦¬

í™”ë©´ì—ì„œ ê²€ìƒ‰ íƒ€ì…(type)ê³¼ í‚¤ì›Œë“œ(keyword)ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆëŠ” UIê°€ í•„ìš”
**but,** ê²€ìƒ‰ ìì²´ê°€ GET ë°©ì‹ì´ë¯€ë¡œ GET ë°©ì‹ì˜ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§(query string)ì„ ì¡°ì‘í•˜ì—¬ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥.

```html
<form action="/guestbook/list" method="get" id="searchForm">
	<div class="inpupt-group">
	<input type="hidden" name="page" value="1">
	<div class="input-group-prepend">
		<select class="custom-select" name="type">
			<option th:selected="${pageRequestDTO.type == null}">-------</option>
			<option value="t" th:selected="${pageRequestDTO.type == 't'}">ì œëª©</option>
			<option value="c" th:selected="${pageRequestDTO.type == 'c'}">ë‚´ìš©</option>
			<option value="w" th:selected="${pageRequestDTO.type == 'w'}">ì‘ì„±ì</option>
			<option value="tc" th:selected="${pageRequestDTO.type == 'tc'}">ì œëª© + ë‚´ìš©</option>
			<option value="tcw" th:selected="${pageRequestDTO.type == 'tcw'}">ì œëª© + ë‚´ìš© + ì‘ì„±ì</option>
		</select>
	</div>
	<input class="form-control" name"keyword" th:value="${pageRequestDTO.keyword}">
	<div class="input-group-append" id="button-addon4">
		<button class="btn btn-outline-secondary btn-search" type="button">Search</button>
		<button class="btn btn-outline-secondary btn-clear" type="button">Clear</button>
	</div>
	</div>
</form>
```

```jsx
<script th:inline="javascript">
	var msg = [[%{msg}]];
	console.log(msg);

	if(msg){
		$(".modal").modal();
	}

	var searchForm = $("#searchForm");
	$('.btn-search').click(function(e){
		searchForm.submit();
	});

	$('.btn-clear').click(function(e){
		searchForm.empty().submit();
	});
</script>
```

### 4.10.4 ì¡°íšŒ í˜ì´ì§€ ê²€ìƒ‰ ì²˜ë¦¬

ì¡°íšŒ í˜ì´ì§€ëŠ” PageRequestDTOë¥¼ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ **@ModealAttribute**ë¥¼ ì´ìš©í•´ì„œ '**requestDTO**'í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

```java
@Getmapping({"/read", "/modify"})
public void read(long gno, @ModelAttribute("requestDTO") PageRequestDTO requestDTO, Model model) {

	log.info("gno: " + gno);
	GuestbookDTO dto = service.read(gno);
	model.addAttribure("dto", dto);
}
```

ğŸ‘‰ ì¡°íšŒ í˜ì´ì§€ì˜ ê²€ìƒ‰ ì²˜ë¦¬

1. ëª©ë¡ í˜ì´ì§€ì—ì„œ íŠ¹ì •í•œ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰ì„ ìˆ˜í–‰
2. ê²€ìƒ‰í•œ ìƒíƒœì—ì„œ íŠ¹ì • ê¸€ì„ ì„ íƒí•´ì„œ ì¡°íšŒ í˜ì´ì§€ë¡œ ì´ë™
3. ì¡°íšŒ í˜ì´ì§€ì—ì„œ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ì„ í´ë¦­í•´ì„œ ì´ë™

### 4.10.5 ìˆ˜ì • ì‘ì—… í›„ ì´ë™ ì²˜ë¦¬

- ë“±ë¡ ì²˜ë¦¬: 1í˜ì´ì§€ë¡œ ì´ë™
- ì‚­ì œ ì²˜ë¦¬: 1í˜ì´ì§€ë¡œ ì´ë™
- ìˆ˜ì • ì²˜ë¦¬: ì¡°íšŒ í˜ì´ì§€ë¡œ ì´ë™

GuestbookControllerëŠ” ì‘ì—…ì´ ëë‚˜ê³  RedirectAttributesë¥¼ ì´ìš©í•´ì„œ ì´ë™í•˜ëŠ” ê²½ìš°ê°€ ì¢…ì¢… ìˆë‹¤.

```html
<h1 class="mt-4">GuestBook Modify Page</h1>

<form action="/guestbook/modify" method="post">
	<!-- í˜ì´ì§€ë²ˆí˜¸ -->
	<input type="hidden" name="page" th:value="${requestDTO.page}">
	<input type="hidden" name="type" th:value="${requestDTO.type}">
	<input type="hidden" name="keyword" th:value="${requestDTO.keyword}">

	<div class="form-group">
	<label >Gno</label>
	<input type="text" class="form-control" name="gno" th:value="${dto.gno}" readonly >
</div>
```

```jsx
$(".listBtn").click(function() {

	// var pageInfo = $("input[name='page']");
	var page = $("input[name='page']");
	var type = $("input[name='type']");
	var keyword = $("input[name='keyword']");

	actionForm.empty(); // form íƒœê·¸ì˜ ëª¨ë“  ë‚´ìš© ì œê±°
	
	actionForm.append(page);
	actionForm.append(type);
	actionForm.append(keyword);
	
	actionForm
			.attr("action", "/guestbook/list")
			.attr("method","get");
	
	actionForm.submit();
})
```

```java
@PostMapping("/modify")
public String modify(GuestbookDTO dto, @ModelAttribute("requestDTO")
											PageRequestDTO requestDTO, RedirectAttributes redirectAttributes){

	log.info("pst modify............................................");
	log.info("dto: " + dto);
	service.modify(dto);

	redirectAttributes.addAttribute("page",requestDTO.getPage());
	redirectAttributes.addAttribute("type",requestDTO.getType());
	redirectAttributes.addAttribute("keyword",requestDTO.getKeyword());
	redirectAttributes.addAttribute("gno",requestDTO.getGno());

	return "redirect:/guestbook/read";
}
```
