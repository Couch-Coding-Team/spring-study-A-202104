## 2.6 ì¿¼ë¦¬ ë©”ì„œë“œ ê¸°ëŠ¥ê³¼ @Query

### 1. ì¿¼ë¦¬ ë©”ì„œë“œë€?

- ë©”ì„œë“œì˜ ì´ë¦„ ìì²´ê°€ ì¿¼ë¦¬ì˜ êµ¬ë¬¸ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” ê¸°ëŠ¥
- docs: [link](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods)

### 2. ì¿¼ë¦¬ ë©”ì„œë“œ ì¢…ë¥˜
|                    | Sample                                                  | JPQL snippet                                                   |
|--------------------|---------------------------------------------------------|----------------------------------------------------------------|
| Distinct           | findDistinctByLastnameAndFirstname                      | select distinct â€¦ where x.lastname = ?1 and x.firstname = ?2   |
| And                | findByLastnameAndFirstname                              | â€¦ where x.lastname = ?1 and x.firstname = ?2                   |
| Or                 | findByLastnameOrFirstname                               | â€¦ where x.lastname = ?1 or x.firstname = ?2                    |
| Is, Equals         | findByFirstname,findByFirstnameIs,findByFirstnameEquals | â€¦ where x.firstname = ?1                                       |
| Between            | findByStartDateBetween                                  | â€¦ where x.startDate between ?1 and ?2                          |
| LessThan           | findByAgeLessThan                                       | â€¦ where x.age < ?1                                             |
| LessThanEqual      | findByAgeLessThanEqual                                  | â€¦ where x.age <= ?1                                            |
| GreaterThan        | findByAgeGreaterThan                                    | â€¦ where x.age > ?1                                             |
| GreaterThanEqual   | findByAgeGreaterThanEqual                               | â€¦ where x.age >= ?1                                            |
| After              | findByStartDateAfter                                    | â€¦ where x.startDate > ?1                                       |
| Before             | findByStartDateBefore                                   | â€¦ where x.startDate < ?1                                       |
| IsNull, Null       | findByAge(Is)Null                                       | â€¦ where x.age is null                                          |
| IsNotNull, NotNull | findByAge(Is)NotNull                                    | â€¦ where x.age not null                                         |
| Like               | findByFirstnameLike                                     | â€¦ where x.firstname like ?1                                    |
| NotLike            | findByFirstnameNotLike                                  | â€¦ where x.firstname not like ?1                                |
| StartingWith       | findByFirstnameStartingWith                             | â€¦ where x.firstname like ?1 (parameter bound with appended %)  |
| EndingWith         | findByFirstnameEndingWith                               | â€¦ where x.firstname like ?1 (parameter bound with prepended %) |
| Containing         | findByFirstnameContaining                               | â€¦ where x.firstname like ?1 (parameter bound wrapped in %)     |
| OrderBy            | findByAgeOrderByLastnameDesc                            | â€¦ where x.age = ?1 order by x.lastname desc                    |
| Not                | findByLastnameNot                                       | â€¦ where x.lastname <> ?1                                       |
| In                 | findByAgeIn(Collection<Age> ages)                       | â€¦ where x.age in ?1                                            |
| NotIn              | findByAgeNotIn(Collection<Age> ages)                    | â€¦ where x.age not in ?1                                        |
| True               | findByActiveTrue()                                      | â€¦ where x.active = true                                        |
| False              | findByActiveFalse()                                     | â€¦ where x.active = false                                       |
| IgnoreCase         | findByFirstnameIgnoreCase                               | â€¦ where UPPER(x.firstname) = UPPER(?1)                         |

### Ex 1) Between ì„ ì‚¬ìš©í•œë‹¤ê³  í–ˆì„ ë•Œ

- **SQL ë¬¸ ì‚¬ìš©ì‹œ**

```sql
SELECT * FROM spring.tbl_memo
WHERE mno >= 5 AND mno <= 9
ORDER BY mno DESC
```

- **Spring Data JPA ì‚¬ìš©ì‹œ**

ğŸ‘‡ MemoRepository ì¸í„°í˜ì´ìŠ¤ì— ì¶”ê°€

```java
package org.zerock.ex2.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.zerock.ex2.entity.Memo;

import java.util.List;

public interface MemoRepository extends JpaRepository<Memo, Long>{
    List<Memo> findByMnoBetweenOrderByMnoDesc(Long from, Long to);
}
```

ğŸ‘‡ MemoRepositoryTests í´ë˜ìŠ¤ì— ì¶”ê°€

```java
package org.zerock.ex2.repository;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.zerock.ex2.entity.Memo;

import java.util.List;
import java.util.Optional;
import java.util.stream.IntStream;

@SpringBootTest
public class MemoRepositoryTests {
    @Autowired
    MemoRepository memoRepository;

    @Test
    public void testQueryMethods(){
        List<Memo> list = memoRepository.findByMnoBetweenOrderByMnoDesc(5L, 9L);
        for (Memo memo : list){
            System.out.println(memo);
        }
    }
}
```

- **ê²°ê³¼**

<img width="573" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-04-20 á„‹á…©á„’á…® 4 08 36" src="https://user-images.githubusercontent.com/60052127/115383831-41fa5280-a211-11eb-9810-23206c63d4ac.png">

### Ex 2) ì¿¼ë¦¬ ë©”ì„œë“œ + Pageable

### ì™œ í•„ìš”í•œê°€?

- Ex 1) ì—ì„œì™€ ê°™ì´ 'OrderBy' ê°€ ë“¤ì–´ê°€ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ê¸¸ì–´ì ¸ì„œ í˜¼ë™í•˜ê¸°ê°€ ì‰¬ì›Œì§. ê·¸ë˜ì„œ Pageable íŒŒë¼ë¯¸í„°ë¥¼ ê°™ì´ ê²°í•©í•´ì„œ ì¢€ ë” ê°„ëµí•œ ë©”ì„œë“œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤.

ğŸ‘‡ MemoRepository ì¸í„°í˜ì´ìŠ¤ì— ì¶”ê°€

```java
package org.zerock.ex2.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.jpa.repository.JpaRepository;
import org.zerock.ex2.entity.Memo;

import java.awt.print.Pageable;
import java.util.List;

public interface MemoRepository extends JpaRepository<Memo, Long>{
    //    ê¸¸ê³  í—·ê°ˆë¦¼
    List<Memo> findByMnoBetweenOrderByMnoDesc(Long from, Long to);

    //    â­ï¸ ì§§ìŒ
    Page<Memo> findByMnoBetween(Long from, Long to, Pageable pageable);
}
```

ğŸ‘‡ MemoRepositoryTests í´ë˜ìŠ¤ì— ì¶”ê°€

```java
@Test
public void testQueryMethodWithPageable(){
    Pageable pageable = PageRequest.of(0, 4, Sort.by("mno").descending());
    Page<Memo> result = memoRepository.findByMnoBetween(1L, 7L, pageable);
    result.get().forEach(memo -> System.out.println(memo));
}
```

- **ê²°ê³¼**

<img width="418" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-04-20 á„‹á…©á„’á…® 4 38 50" src="https://user-images.githubusercontent.com/60052127/115384022-80900d00-a211-11eb-8f05-913a3c8d59a1.png">

### Ex 3) deleteByë¡œ ì‹œì‘í•˜ëŠ” ì‚­ì œì²˜ë¦¬

ğŸ‘‡ MemoRepository ì¸í„°í˜ì´ìŠ¤ì— ì¶”ê°€

```java
import org.springframework.data.domain.Page;
import org.springframework.data.jpa.repository.JpaRepository;
import org.zerock.ex2.entity.Memo;

import org.springframework.data.domain.Pageable;
import java.util.List;

public interface MemoRepository extends JpaRepository<Memo, Long>{

    //    delete
    void deleteMemoByMnoLessThan(Long num);
}
```

ğŸ‘‡ MemoRepositoryTests í´ë˜ìŠ¤ì— ì¶”ê°€

```java
		@Commit
    @Transactional
    @Test
    public void testDeleteQueryMethods(){
        memoRepository.deleteMemoByMnoLessThan(2L);
    }
```

@Transactional ì–´ë…¸í…Œì´ì…˜ í•„ìš”í•œ ì´ìœ ?

- deleteBy..ì˜ ê²½ìš° ìš°ì„  'select'ë¬¸ìœ¼ë¡œ í•´ë‹¹ ì—”í‹°í‹° ê°ì²´ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ê³¼ ê° ì—”í‹°í‹°ë¥¼ ì‚­ì œí•˜ëŠ” ì‘ì—…ì´ ê°™ì´ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸.



@Commit ì–´ë…¸í…Œì´ì…˜ í•„ìš”í•œ ì´ìœ ?

- ìµœì¢… ê²°ê³¼ë¥¼ ì»¤ë°‹í•˜ê¸° ìœ„í•´ì„œ ì‚¬ìš©. ì´ë¥¼ ì ìš©í•˜ì§€ ì•Šìœ¼ë©´ deleteBy.. ê°€ ë¡¤ë°± ì²˜ë¦¬ë˜ì–´ì„œ ê²°ê³¼ê°€ ë°˜ì˜ë˜ì§€ ì•ŠìŒ.

ê·¸ëŸ°ë° deleteBy ëŠ” ì‹¤ì œ ê°œë°œì—ì„œ ë§ì´ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•¨. ì™œ? SQL ì²˜ëŸ¼ í•œë²ˆì— ì‚­ì œê°€ ì´ë£¨ì–´ì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ê° ì—”í‹°í‹° ê°ì²´ë¥¼ í•˜ë‚˜ì”© ì‚­ì œí•˜ê¸° ë•Œë¬¸!
